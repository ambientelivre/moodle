<<<<<<< HEAD
{"version":3,"file":"message_drawer.min.js","sources":["../src/message_drawer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Controls the message drawer.\n *\n * @module     core_message/message_drawer\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/custom_interaction_events',\n    'core/pubsub',\n    'core_message/message_drawer_view_contact',\n    'core_message/message_drawer_view_contacts',\n    'core_message/message_drawer_view_conversation',\n    'core_message/message_drawer_view_group_info',\n    'core_message/message_drawer_view_overview',\n    'core_message/message_drawer_view_search',\n    'core_message/message_drawer_view_settings',\n    'core_message/message_drawer_router',\n    'core_message/message_drawer_routes',\n    'core_message/message_drawer_events',\n    'core_message/message_drawer_helper',\n    'core/pending',\n    'core/drawer',\n    'core/toast',\n    'core/str',\n    'core/config',\n    'core/ajax',\n],\nfunction(\n    $,\n    CustomEvents,\n    PubSub,\n    ViewContact,\n    ViewContacts,\n    ViewConversation,\n    ViewGroupInfo,\n    ViewOverview,\n    ViewSearch,\n    ViewSettings,\n    Router,\n    Routes,\n    Events,\n    Helper,\n    Pending,\n    Drawer,\n    Toast,\n    Str,\n    Config,\n    Ajax,\n) {\n\n    var SELECTORS = {\n        DRAWER: '[data-region=\"right-hand-drawer\"]',\n        JUMPTO: '.popover-region [data-region=\"jumpto\"]',\n        PANEL_BODY_CONTAINER: '[data-region=\"panel-body-container\"]',\n        PANEL_HEADER_CONTAINER: '[data-region=\"panel-header-container\"]',\n        VIEW_CONTACT: '[data-region=\"view-contact\"]',\n        VIEW_CONTACTS: '[data-region=\"view-contacts\"]',\n        VIEW_CONVERSATION: '[data-region=\"view-conversation\"]',\n        VIEW_CONVERSATION_WITH_ID: '[data-region=\"view-conversation\"][data-conversation-id]',\n        VIEW_CONVERSATION_WITH_USER: '[data-region=\"view-conversation\"][data-other-user-id]',\n        VIEW_GROUP_INFO: '[data-region=\"view-group-info\"]',\n        VIEW_OVERVIEW: '[data-region=\"view-overview\"]',\n        VIEW_SEARCH: '[data-region=\"view-search\"]',\n        VIEW_SETTINGS: '[data-region=\"view-settings\"]',\n        ROUTES: '[data-route]',\n        ROUTES_BACK: '[data-route-back]',\n        HEADER_CONTAINER: '[data-region=\"header-container\"]',\n        BODY_CONTAINER: '[data-region=\"body-container\"]',\n        FOOTER_CONTAINER: '[data-region=\"footer-container\"]',\n        CLOSE_BUTTON: '[data-action=\"closedrawer\"]',\n        MESSAGE_INDEX: '[data-region=\"message-index\"]',\n        MESSAGE_TEXT_AREA: '[data-region=\"send-message-txt\"]',\n    };\n\n    /**\n     * Get elements for route.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {Object} root The message drawer container.\n     * @param {string} selector The route container.\n     *\n     * @return {array} elements Found route container objects.\n     */\n    var getParametersForRoute = function(namespace, root, selector) {\n\n        var header = root.find(SELECTORS.HEADER_CONTAINER).find(selector);\n        if (!header.length) {\n            header = root.find(SELECTORS.PANEL_HEADER_CONTAINER).find(selector);\n        }\n        var body = root.find(SELECTORS.BODY_CONTAINER).find(selector);\n        if (!body.length) {\n            body = root.find(SELECTORS.PANEL_BODY_CONTAINER).find(selector);\n        }\n        var footer = root.find(SELECTORS.FOOTER_CONTAINER).find(selector);\n\n        return [\n            namespace,\n            header.length ? header : null,\n            body.length ? body : null,\n            footer.length ? footer : null\n        ];\n    };\n\n    var routes = [\n        [Routes.VIEW_CONTACT, SELECTORS.VIEW_CONTACT, ViewContact.show, ViewContact.description],\n        [Routes.VIEW_CONTACTS, SELECTORS.VIEW_CONTACTS, ViewContacts.show, ViewContacts.description],\n        [Routes.VIEW_CONVERSATION, SELECTORS.VIEW_CONVERSATION, ViewConversation.show, ViewConversation.description],\n        [Routes.VIEW_GROUP_INFO, SELECTORS.VIEW_GROUP_INFO, ViewGroupInfo.show, ViewGroupInfo.description],\n        [Routes.VIEW_OVERVIEW, SELECTORS.VIEW_OVERVIEW, ViewOverview.show, ViewOverview.description],\n        [Routes.VIEW_SEARCH, SELECTORS.VIEW_SEARCH, ViewSearch.show, ViewSearch.description],\n        [Routes.VIEW_SETTINGS, SELECTORS.VIEW_SETTINGS, ViewSettings.show, ViewSettings.description]\n    ];\n\n    /**\n     * Create routes.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {Object} root The message drawer container.\n     */\n    var createRoutes = function(namespace, root) {\n        routes.forEach(function(route) {\n            Router.add(namespace, route[0], getParametersForRoute(namespace, root, route[1]), route[2], route[3]);\n        });\n    };\n\n    /**\n     * Show the message drawer.\n     *\n     * @param {string} namespace The route namespace.\n     * @param {Object} root The message drawer container.\n     */\n    var show = function(namespace, root) {\n        if (!root.attr('data-shown')) {\n            Router.go(namespace, Routes.VIEW_OVERVIEW);\n            root.attr('data-shown', true);\n        }\n\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            Drawer.show(drawerRoot);\n        }\n    };\n\n    /**\n     * Hide the message drawer.\n     *\n     * @param {Object} root The message drawer container.\n     */\n    var hide = function(root) {\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            Drawer.hide(drawerRoot);\n        }\n    };\n\n    /**\n     * Check if the drawer is visible.\n     *\n     * @param {Object} root The message drawer container.\n     * @return {boolean}\n     */\n    var isVisible = function(root) {\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            return Drawer.isVisible(drawerRoot);\n        }\n        return true;\n    };\n\n    /**\n     * Set Jump from button\n     *\n     * @param {String} buttonid The originating button id\n     */\n    var setJumpFrom = function(buttonid) {\n        $(SELECTORS.DRAWER).attr('data-origin', buttonid);\n    };\n\n    /**\n     * Store an unsent message.\n     *\n     * Don't store this if the user has already seen the unsent message.\n     * This avoids spamming and ensures the user is only reminded once per unsent message.\n     * If the unsent message is sent, this attribute is removed and notification is possible again (see sendMessage).\n     */\n    const storeUnsentMessage = async() => {\n        const messageTextArea = document.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\n\n        if (messageTextArea.value.trim().length > 0 && !messageTextArea.hasAttribute('data-unsent-message-viewed')) {\n\n            let message = messageTextArea.value;\n            let conversationid = 0;\n            let otheruserid = 0;\n\n            // We don't always have a conversation to link the unsent message to, so let's check for that.\n            const conversationId = document.querySelector(SELECTORS.VIEW_CONVERSATION_WITH_ID);\n            if (conversationId) {\n                const conversationWithId = messageTextArea.closest(SELECTORS.VIEW_CONVERSATION_WITH_ID);\n                conversationid = conversationWithId.getAttribute('data-conversation-id');\n            }\n            // Store the 'other' user id if it is there. This can be used to create conversations.\n            const conversationUser = document.querySelector(SELECTORS.VIEW_CONVERSATION_WITH_USER);\n            if (conversationUser) {\n                const conversationWithUser = messageTextArea.closest(SELECTORS.VIEW_CONVERSATION_WITH_USER);\n                otheruserid = conversationWithUser.getAttribute('data-other-user-id');\n            }\n\n            setStoredUnsentMessage(message, conversationid, otheruserid);\n        }\n    };\n\n    /**\n     * Get the stored unsent message from the session via web service.\n     *\n     * @returns {Promise}\n     */\n    const getStoredUnsentMessage = () => Ajax.call([{\n        methodname: 'core_message_get_unsent_message',\n        args: {}\n    }])[0];\n\n    /**\n     * Set the unsent message value in the session via web service.\n     *\n     * SendBeacon is used here because this is called on 'beforeunload'.\n     *\n     * @param {string} message The message string.\n     * @param {number} conversationid The conversation id.\n     * @param {number} otheruserid The other user id.\n     * @returns {Promise}\n     */\n    const setStoredUnsentMessage = (message, conversationid, otheruserid) => {\n        const method = 'core_message_set_unsent_message';\n        const requestUrl = new URL(`${Config.wwwroot}/lib/ajax/service.php`);\n        requestUrl.searchParams.set('sesskey', Config.sesskey);\n        requestUrl.searchParams.set('info', method);\n\n        navigator.sendBeacon(requestUrl, JSON.stringify([{\n            index: 0,\n            methodname: method,\n            args: {\n                message: message,\n                conversationid: conversationid,\n                otheruserid: otheruserid,\n            }\n        }]));\n    };\n\n    /**\n     * Check for an unsent message.\n     *\n     * @param {String} uniqueId Unique identifier for the Routes.\n     * @param {Object} root The message drawer container.\n     */\n    const getUnsentMessage = async(uniqueId, root) => {\n        let type;\n        let messageRoot;\n\n        // We need to check if we are on the message/index page.\n        // This logic is needed to handle the two message widgets here and ensure we are targetting the right one.\n        const messageIndex = document.querySelector(SELECTORS.MESSAGE_INDEX);\n        if (messageIndex !== null) {\n            type = 'index';\n            messageRoot = document.getElementById(`message-index-${uniqueId}`);\n            if (!messageRoot) {\n                // This is not the correct widget.\n                return;\n            }\n\n        } else {\n            type = 'drawer';\n            messageRoot = document.getElementById(`message-drawer-${uniqueId}`);\n        }\n\n        const storedMessage = await getStoredUnsentMessage();\n        const messageTextArea = messageRoot.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\n        if (storedMessage.message && messageTextArea !== null) {\n            showUnsentMessage(messageTextArea, storedMessage, type, uniqueId, root);\n        }\n    };\n\n    /**\n     * Show an unsent message.\n     *\n     * There are two message widgets on the message/index page.\n     * Because of that, we need to try and target the correct widget.\n     *\n     * @param {String} textArea The textarea element.\n     * @param {Object} stored The stored message content.\n     * @param {String} type Is this from the drawer or index page?\n     * @param {String} uniqueId Unique identifier for the Routes.\n     * @param {Object} root The message drawer container.\n     */\n    const showUnsentMessage = (textArea, stored, type, uniqueId, root) => {\n        // The user has already been notified.\n        if (textArea.hasAttribute('data-unsent-message-viewed')) {\n            return;\n        }\n\n        // Depending on the type, show the conversation with the data we have available.\n        // A conversation can be continued if there is a conversationid.\n        // If the user was messaging a new non-contact, we won't have a conversationid yet.\n        // In that case, we use the otheruserid value to start a conversation with them.\n        switch (type) {\n            case 'index':\n                // Show the conversation in the main panel on the message/index page.\n                if (stored.conversationid) {\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, stored.conversationid, 'frompanel');\n                // There was no conversation id, let's get a conversation going using the user id.\n                } else if (stored.otheruserid) {\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, null, 'create', stored.otheruserid);\n                }\n                break;\n\n            case 'drawer':\n                // Open the drawer and show the conversation.\n                if (stored.conversationid) {\n                    let args = {\n                        conversationid: stored.conversationid\n                    };\n                    Helper.showConversation(args);\n                // There was no conversation id, let's get a conversation going using the user id.\n                } else if (stored.otheruserid) {\n                    show(uniqueId, root);\n                    Router.go(uniqueId, Routes.VIEW_CONVERSATION, null, 'create', stored.otheruserid);\n                }\n                break;\n        }\n\n        // Populate the text area.\n        textArea.value = stored.message;\n        textArea.setAttribute('data-unsent-message-viewed', 1);\n\n        // Notify the user.\n        Toast.add(Str.get_string('unsentmessagenotification', 'core_message'));\n    };\n\n    /**\n     * Listen to and handle events for routing, showing and hiding the message drawer.\n     *\n     * @param {string} namespace The route namespace.\n     * @param {Object} root The message drawer container.\n     * @param {bool} alwaysVisible Is this messaging app always shown?\n     */\n    var registerEventListeners = function(namespace, root, alwaysVisible) {\n        CustomEvents.define(root, [CustomEvents.events.activate]);\n        var paramRegex = /^data-route-param-?(\\d*)$/;\n\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES, function(e, data) {\n            var element = $(e.target).closest(SELECTORS.ROUTES);\n            var route = element.attr('data-route');\n            var attributes = [];\n\n            for (var i = 0; i < element[0].attributes.length; i++) {\n                attributes.push(element[0].attributes[i]);\n            }\n\n            var paramAttributes = attributes.filter(function(attribute) {\n                var name = attribute.nodeName;\n                var match = paramRegex.test(name);\n                return match;\n            });\n            paramAttributes.sort(function(a, b) {\n                var aParts = paramRegex.exec(a.nodeName);\n                var bParts = paramRegex.exec(b.nodeName);\n                var aIndex = aParts.length > 1 ? aParts[1] : 0;\n                var bIndex = bParts.length > 1 ? bParts[1] : 0;\n\n                if (aIndex < bIndex) {\n                    return -1;\n                } else if (bIndex < aIndex) {\n                    return 1;\n                } else {\n                    return 0;\n                }\n            });\n\n            var params = paramAttributes.map(function(attribute) {\n                return attribute.nodeValue;\n            });\n\n            var routeParams = [namespace, route].concat(params);\n\n            Router.go.apply(null, routeParams);\n\n            data.originalEvent.preventDefault();\n        });\n\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES_BACK, function(e, data) {\n            Router.back(namespace);\n\n            data.originalEvent.preventDefault();\n        });\n\n        // These are theme-specific to help us fix random behat fails.\n        // These events target those events defined in BS3 and BS4 onwards.\n        root[0].querySelectorAll('.collapse').forEach((collapse) => {\n            collapse.addEventListener('hide.bs.collapse', (e) => {\n                var pendingPromise = new Pending();\n                e.target.addEventListener('hidden.bs.collapse', function() {\n                    pendingPromise.resolve();\n                }, {once: true});\n            });\n        });\n\n        root[0].querySelectorAll('.collapse').forEach((collapse) => {\n            collapse.addEventListener('show.bs.collapse', (e) => {\n                var pendingPromise = new Pending();\n                e.target.addEventListener('shown.bs.collapse', function() {\n                    pendingPromise.resolve();\n                }, {once: true});\n            });\n        });\n\n        $(SELECTORS.JUMPTO).focus(function() {\n            var firstInput = root.find(SELECTORS.CLOSE_BUTTON);\n            if (firstInput.length) {\n                firstInput.focus();\n            } else {\n                $(SELECTORS.HEADER_CONTAINER).find(SELECTORS.ROUTES_BACK).focus();\n            }\n        });\n\n        $(SELECTORS.DRAWER).focus(function() {\n            var button = $(this).attr('data-origin');\n            if (button) {\n                $('#' + button).focus();\n            }\n        });\n\n        if (!alwaysVisible) {\n            PubSub.subscribe(Events.SHOW, function() {\n                show(namespace, root);\n            });\n\n            PubSub.subscribe(Events.HIDE, function() {\n                hide(root);\n            });\n\n            PubSub.subscribe(Events.TOGGLE_VISIBILITY, function(buttonid) {\n                if (isVisible(root)) {\n                    hide(root);\n                    $(SELECTORS.JUMPTO).attr('tabindex', -1);\n                } else {\n                    show(namespace, root);\n                    setJumpFrom(buttonid);\n                    $(SELECTORS.JUMPTO).attr('tabindex', 0);\n                }\n            });\n        }\n\n        PubSub.subscribe(Events.SHOW_CONVERSATION, function(args) {\n            setJumpFrom(args.buttonid);\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_CONVERSATION, args.conversationid);\n        });\n\n        var closebutton = root.find(SELECTORS.CLOSE_BUTTON);\n        closebutton.on(CustomEvents.events.activate, function(e, data) {\n            data.originalEvent.preventDefault();\n\n            var button = $(SELECTORS.DRAWER).attr('data-origin');\n            if (button) {\n                $('#' + button).focus();\n            }\n            PubSub.publish(Events.TOGGLE_VISIBILITY);\n        });\n\n        PubSub.subscribe(Events.CREATE_CONVERSATION_WITH_USER, function(args) {\n            setJumpFrom(args.buttonid);\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_CONVERSATION, null, 'create', args.userid);\n        });\n\n        PubSub.subscribe(Events.SHOW_SETTINGS, function() {\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_SETTINGS);\n        });\n\n        PubSub.subscribe(Events.PREFERENCES_UPDATED, function(preferences) {\n            var filteredPreferences = preferences.filter(function(preference) {\n                return preference.type == 'message_entertosend';\n            });\n            var enterToSendPreference = filteredPreferences.length ? filteredPreferences[0] : null;\n\n            if (enterToSendPreference) {\n                var viewConversationFooter = root.find(SELECTORS.FOOTER_CONTAINER).find(SELECTORS.VIEW_CONVERSATION);\n                viewConversationFooter.attr('data-enter-to-send', enterToSendPreference.value);\n            }\n        });\n\n        // If our textarea is modified, remove the attribute which indicates the user has seen the unsent message notification.\n        // This will allow the user to be notified again.\n        const textArea = document.querySelector(SELECTORS.MESSAGE_TEXT_AREA);\n        if (textArea) {\n            textArea.addEventListener('keyup', function() {\n                textArea.removeAttribute('data-unsent-message-viewed');\n            });\n        }\n\n        // Catch any unsent messages and store them.\n        window.addEventListener('beforeunload', storeUnsentMessage);\n    };\n\n    /**\n     * Initialise the message drawer.\n     *\n     * @param {Object} root The message drawer container.\n     * @param {String} uniqueId Unique identifier for the Routes\n     * @param {bool} alwaysVisible Should we show the app now, or wait for the user?\n     * @param {Object} route\n     */\n    var init = function(root, uniqueId, alwaysVisible, route) {\n        root = $(root);\n        createRoutes(uniqueId, root);\n        registerEventListeners(uniqueId, root, alwaysVisible);\n\n        if (alwaysVisible) {\n            show(uniqueId, root);\n\n            if (route) {\n                var routeParams = route.params || [];\n                routeParams = [uniqueId, route.path].concat(routeParams);\n                Router.go.apply(null, routeParams);\n            }\n        }\n\n        // Mark the drawer as ready.\n        Helper.markDrawerReady();\n\n        // Get and show any unsent message.\n        getUnsentMessage(uniqueId, root);\n    };\n\n    return {\n        init: init,\n    };\n});\n"],"names":["define","$","CustomEvents","PubSub","ViewContact","ViewContacts","ViewConversation","ViewGroupInfo","ViewOverview","ViewSearch","ViewSettings","Router","Routes","Events","Helper","Pending","Drawer","Toast","Str","Config","Ajax","SELECTORS","routes","VIEW_CONTACT","show","description","VIEW_CONTACTS","VIEW_CONVERSATION","VIEW_GROUP_INFO","VIEW_OVERVIEW","VIEW_SEARCH","VIEW_SETTINGS","createRoutes","namespace","root","forEach","route","add","selector","header","find","length","body","footer","getParametersForRoute","attr","go","drawerRoot","getDrawerRoot","hide","setJumpFrom","buttonid","storeUnsentMessage","async","messageTextArea","document","querySelector","value","trim","hasAttribute","message","conversationid","otheruserid","closest","getAttribute","setStoredUnsentMessage","method","requestUrl","URL","wwwroot","searchParams","set","sesskey","navigator","sendBeacon","JSON","stringify","index","methodname","args","getUnsentMessage","uniqueId","type","messageRoot","getElementById","storedMessage","call","showUnsentMessage","textArea","stored","showConversation","setAttribute","get_string","registerEventListeners","alwaysVisible","events","activate","paramRegex","on","e","data","element","target","attributes","i","push","paramAttributes","filter","attribute","name","nodeName","test","sort","a","b","aParts","exec","bParts","aIndex","bIndex","params","map","nodeValue","routeParams","concat","apply","originalEvent","preventDefault","back","querySelectorAll","collapse","addEventListener","pendingPromise","resolve","once","focus","firstInput","button","this","subscribe","SHOW","HIDE","TOGGLE_VISIBILITY","isVisible","SHOW_CONVERSATION","publish","CREATE_CONVERSATION_WITH_USER","userid","SHOW_SETTINGS","PREFERENCES_UPDATED","preferences","filteredPreferences","preference","enterToSendPreference","removeAttribute","window","init","path","markDrawerReady"],"mappings":"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"}
=======
{"version":3,"sources":["../src/message_drawer.js"],"names":["define","$","CustomEvents","PubSub","ViewContact","ViewContacts","ViewConversation","ViewGroupInfo","ViewOverview","ViewSearch","ViewSettings","Router","Routes","Events","Pending","Drawer","SELECTORS","DRAWER","JUMPTO","PANEL_BODY_CONTAINER","PANEL_HEADER_CONTAINER","VIEW_CONTACT","VIEW_CONTACTS","VIEW_CONVERSATION","VIEW_GROUP_INFO","VIEW_OVERVIEW","VIEW_SEARCH","VIEW_SETTINGS","ROUTES","ROUTES_BACK","HEADER_CONTAINER","BODY_CONTAINER","FOOTER_CONTAINER","getParametersForRoute","namespace","root","selector","header","find","length","body","footer","routes","show","description","createRoutes","forEach","route","add","attr","go","drawerRoot","getDrawerRoot","hide","isVisible","setJumpFrom","buttonid","registerEventListeners","alwaysVisible","events","activate","paramRegex","on","e","data","element","target","closest","attributes","i","push","paramAttributes","filter","attribute","name","nodeName","match","test","sort","a","b","aParts","exec","bParts","aIndex","bIndex","params","map","nodeValue","routeParams","concat","apply","originalEvent","preventDefault","back","pendingPromise","one","resolve","focus","firstInput","button","subscribe","SHOW","HIDE","TOGGLE_VISIBILITY","SHOW_CONVERSATION","args","conversationid","CREATE_CONVERSATION_WITH_USER","userid","SHOW_SETTINGS","PREFERENCES_UPDATED","preferences","filteredPreferences","preference","type","enterToSendPreference","viewConversationFooter","value","init","uniqueId","path"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Controls the message drawer.\n *\n * @module     core_message/message_drawer\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/custom_interaction_events',\n    'core/pubsub',\n    'core_message/message_drawer_view_contact',\n    'core_message/message_drawer_view_contacts',\n    'core_message/message_drawer_view_conversation',\n    'core_message/message_drawer_view_group_info',\n    'core_message/message_drawer_view_overview',\n    'core_message/message_drawer_view_search',\n    'core_message/message_drawer_view_settings',\n    'core_message/message_drawer_router',\n    'core_message/message_drawer_routes',\n    'core_message/message_drawer_events',\n    'core/pending',\n    'core/drawer',\n],\nfunction(\n    $,\n    CustomEvents,\n    PubSub,\n    ViewContact,\n    ViewContacts,\n    ViewConversation,\n    ViewGroupInfo,\n    ViewOverview,\n    ViewSearch,\n    ViewSettings,\n    Router,\n    Routes,\n    Events,\n    Pending,\n    Drawer\n) {\n\n    var SELECTORS = {\n        DRAWER: '[data-region=\"right-hand-drawer\"]',\n        JUMPTO: '.popover-region [data-region=\"jumpto\"]',\n        PANEL_BODY_CONTAINER: '[data-region=\"panel-body-container\"]',\n        PANEL_HEADER_CONTAINER: '[data-region=\"panel-header-container\"]',\n        VIEW_CONTACT: '[data-region=\"view-contact\"]',\n        VIEW_CONTACTS: '[data-region=\"view-contacts\"]',\n        VIEW_CONVERSATION: '[data-region=\"view-conversation\"]',\n        VIEW_GROUP_INFO: '[data-region=\"view-group-info\"]',\n        VIEW_OVERVIEW: '[data-region=\"view-overview\"]',\n        VIEW_SEARCH: '[data-region=\"view-search\"]',\n        VIEW_SETTINGS: '[data-region=\"view-settings\"]',\n        ROUTES: '[data-route]',\n        ROUTES_BACK: '[data-route-back]',\n        HEADER_CONTAINER: '[data-region=\"header-container\"]',\n        BODY_CONTAINER: '[data-region=\"body-container\"]',\n        FOOTER_CONTAINER: '[data-region=\"footer-container\"]',\n    };\n\n    /**\n     * Get elements for route.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {Object} root The message drawer container.\n     * @param {string} selector The route container.\n     *\n     * @return {array} elements Found route container objects.\n    */\n    var getParametersForRoute = function(namespace, root, selector) {\n\n        var header = root.find(SELECTORS.HEADER_CONTAINER).find(selector);\n        if (!header.length) {\n            header = root.find(SELECTORS.PANEL_HEADER_CONTAINER).find(selector);\n        }\n        var body = root.find(SELECTORS.BODY_CONTAINER).find(selector);\n        if (!body.length) {\n            body = root.find(SELECTORS.PANEL_BODY_CONTAINER).find(selector);\n        }\n        var footer = root.find(SELECTORS.FOOTER_CONTAINER).find(selector);\n\n        return [\n            namespace,\n            header.length ? header : null,\n            body.length ? body : null,\n            footer.length ? footer : null\n        ];\n    };\n\n    var routes = [\n        [Routes.VIEW_CONTACT, SELECTORS.VIEW_CONTACT, ViewContact.show, ViewContact.description],\n        [Routes.VIEW_CONTACTS, SELECTORS.VIEW_CONTACTS, ViewContacts.show, ViewContacts.description],\n        [Routes.VIEW_CONVERSATION, SELECTORS.VIEW_CONVERSATION, ViewConversation.show, ViewConversation.description],\n        [Routes.VIEW_GROUP_INFO, SELECTORS.VIEW_GROUP_INFO, ViewGroupInfo.show, ViewGroupInfo.description],\n        [Routes.VIEW_OVERVIEW, SELECTORS.VIEW_OVERVIEW, ViewOverview.show, ViewOverview.description],\n        [Routes.VIEW_SEARCH, SELECTORS.VIEW_SEARCH, ViewSearch.show, ViewSearch.description],\n        [Routes.VIEW_SETTINGS, SELECTORS.VIEW_SETTINGS, ViewSettings.show, ViewSettings.description]\n    ];\n\n    /**\n     * Create routes.\n     *\n     * @param {String} namespace Unique identifier for the Routes\n     * @param {Object} root The message drawer container.\n     */\n    var createRoutes = function(namespace, root) {\n        routes.forEach(function(route) {\n            Router.add(namespace, route[0], getParametersForRoute(namespace, root, route[1]), route[2], route[3]);\n        });\n    };\n\n    /**\n     * Show the message drawer.\n     *\n     * @param {string} namespace The route namespace.\n     * @param {Object} root The message drawer container.\n     */\n    var show = function(namespace, root) {\n        if (!root.attr('data-shown')) {\n            Router.go(namespace, Routes.VIEW_OVERVIEW);\n            root.attr('data-shown', true);\n        }\n\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            Drawer.show(drawerRoot);\n        }\n    };\n\n    /**\n     * Hide the message drawer.\n     *\n     * @param {Object} root The message drawer container.\n     */\n    var hide = function(root) {\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            Drawer.hide(drawerRoot);\n        }\n    };\n\n    /**\n     * Check if the drawer is visible.\n     *\n     * @param {Object} root The message drawer container.\n     * @return {boolean}\n     */\n    var isVisible = function(root) {\n        var drawerRoot = Drawer.getDrawerRoot(root);\n        if (drawerRoot.length) {\n            return Drawer.isVisible(drawerRoot);\n        }\n        return true;\n    };\n\n    /**\n     * Set Jump from button\n     *\n     * @param {String} buttonid The originating button id\n     */\n    var setJumpFrom = function(buttonid) {\n        $(SELECTORS.DRAWER).attr('data-origin', buttonid);\n    };\n\n    /**\n     * Listen to and handle events for routing, showing and hiding the message drawer.\n     *\n     * @param {string} namespace The route namespace.\n     * @param {Object} root The message drawer container.\n     * @param {bool} alwaysVisible Is this messaging app always shown?\n     */\n    var registerEventListeners = function(namespace, root, alwaysVisible) {\n        CustomEvents.define(root, [CustomEvents.events.activate]);\n        var paramRegex = /^data-route-param-?(\\d*)$/;\n\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES, function(e, data) {\n            var element = $(e.target).closest(SELECTORS.ROUTES);\n            var route = element.attr('data-route');\n            var attributes = [];\n\n            for (var i = 0; i < element[0].attributes.length; i++) {\n                attributes.push(element[0].attributes[i]);\n            }\n\n            var paramAttributes = attributes.filter(function(attribute) {\n                var name = attribute.nodeName;\n                var match = paramRegex.test(name);\n                return match;\n            });\n            paramAttributes.sort(function(a, b) {\n                var aParts = paramRegex.exec(a.nodeName);\n                var bParts = paramRegex.exec(b.nodeName);\n                var aIndex = aParts.length > 1 ? aParts[1] : 0;\n                var bIndex = bParts.length > 1 ? bParts[1] : 0;\n\n                if (aIndex < bIndex) {\n                    return -1;\n                } else if (bIndex < aIndex) {\n                    return 1;\n                } else {\n                    return 0;\n                }\n            });\n\n            var params = paramAttributes.map(function(attribute) {\n                return attribute.nodeValue;\n            });\n\n            var routeParams = [namespace, route].concat(params);\n\n            Router.go.apply(null, routeParams);\n\n            data.originalEvent.preventDefault();\n        });\n\n        root.on(CustomEvents.events.activate, SELECTORS.ROUTES_BACK, function(e, data) {\n            Router.back(namespace);\n\n            data.originalEvent.preventDefault();\n        });\n\n        // These are theme-specific to help us fix random behat fails.\n        // These events target those events defined in BS3 and BS4 onwards.\n        root.on('hide.bs.collapse', '.collapse', function(e) {\n            var pendingPromise = new Pending();\n            $(e.target).one('hidden.bs.collapse', function() {\n                pendingPromise.resolve();\n            });\n        });\n\n        root.on('show.bs.collapse', '.collapse', function(e) {\n            var pendingPromise = new Pending();\n            $(e.target).one('shown.bs.collapse', function() {\n                pendingPromise.resolve();\n            });\n        });\n\n        $(SELECTORS.JUMPTO).focus(function() {\n            var firstInput = $(SELECTORS.HEADER_CONTAINER).find('input:visible');\n            if (firstInput.length) {\n                firstInput.focus();\n            } else {\n                $(SELECTORS.HEADER_CONTAINER).find(SELECTORS.ROUTES_BACK).focus();\n            }\n        });\n\n        $(SELECTORS.DRAWER).focus(function() {\n            var button = $(this).attr('data-origin');\n            if (button) {\n                $('#' + button).focus();\n            }\n        });\n\n        if (!alwaysVisible) {\n            PubSub.subscribe(Events.SHOW, function() {\n                show(namespace, root);\n            });\n\n            PubSub.subscribe(Events.HIDE, function() {\n                hide(root);\n            });\n\n            PubSub.subscribe(Events.TOGGLE_VISIBILITY, function(buttonid) {\n                if (isVisible(root)) {\n                    hide(root);\n                    $(SELECTORS.JUMPTO).attr('tabindex', -1);\n                } else {\n                    show(namespace, root);\n                    setJumpFrom(buttonid);\n                    $(SELECTORS.JUMPTO).attr('tabindex', 0);\n                }\n            });\n        }\n\n        PubSub.subscribe(Events.SHOW_CONVERSATION, function(args) {\n            setJumpFrom(args.buttonid);\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_CONVERSATION, args.conversationid);\n        });\n\n        PubSub.subscribe(Events.CREATE_CONVERSATION_WITH_USER, function(args) {\n            setJumpFrom(args.buttonid);\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_CONVERSATION, null, 'create', args.userid);\n        });\n\n        PubSub.subscribe(Events.SHOW_SETTINGS, function() {\n            show(namespace, root);\n            Router.go(namespace, Routes.VIEW_SETTINGS);\n        });\n\n        PubSub.subscribe(Events.PREFERENCES_UPDATED, function(preferences) {\n            var filteredPreferences = preferences.filter(function(preference) {\n                return preference.type == 'message_entertosend';\n            });\n            var enterToSendPreference = filteredPreferences.length ? filteredPreferences[0] : null;\n\n            if (enterToSendPreference) {\n                var viewConversationFooter = root.find(SELECTORS.FOOTER_CONTAINER).find(SELECTORS.VIEW_CONVERSATION);\n                viewConversationFooter.attr('data-enter-to-send', enterToSendPreference.value);\n            }\n        });\n    };\n\n    /**\n     * Initialise the message drawer.\n     *\n     * @param {Object} root The message drawer container.\n     * @param {String} uniqueId Unique identifier for the Routes\n     * @param {bool} alwaysVisible Should we show the app now, or wait for the user?\n     * @param {Object} route\n     */\n    var init = function(root, uniqueId, alwaysVisible, route) {\n        root = $(root);\n        createRoutes(uniqueId, root);\n        registerEventListeners(uniqueId, root, alwaysVisible);\n\n        if (alwaysVisible) {\n            show(uniqueId, root);\n\n            if (route) {\n                var routeParams = route.params || [];\n                routeParams = [uniqueId, route.path].concat(routeParams);\n                Router.go.apply(null, routeParams);\n            }\n        }\n    };\n\n    return {\n        init: init,\n    };\n});\n"],"file":"message_drawer.min.js"}
>>>>>>> upstream/MOODLE_38_STABLE
